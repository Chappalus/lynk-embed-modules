!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).LynkPixel={})}(this,function(e){"use strict";class t{constructor(e,t=!1){this.prefix=e,this.debugMode=t}log(e,t,...i){if(!this.debugMode&&"debug"===e)return;const n=`[${(new Date).toISOString()}] [${this.prefix}] [${e.toUpperCase()}] ${t}`;switch(e){case"error":console.error(n,...i);break;case"warn":console.warn(n,...i);break;case"info":console.info(n,...i);break;default:console.log(n,...i)}}debug(e,...t){this.log("debug",e,...t)}info(e,...t){this.log("info",e,...t)}warn(e,...t){this.log("warn",e,...t)}error(e,...t){this.log("error",e,...t)}}function i(e,t,i=365){const n=new Date(Date.now()+864e5*i).toUTCString();document.cookie=`${e}=${encodeURIComponent(t)}; expires=${n}; path=/; SameSite=Lax`}function n(e,t,i,n){return new(i||(i=Promise))(function(o,a){function s(e){try{r(n.next(e))}catch(e){a(e)}}function c(e){try{r(n.throw(e))}catch(e){a(e)}}function r(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(s,c)}r((n=n.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class o{constructor(e){this.queue=[],this.flushInterval=null,this.FLUSH_INTERVAL_MS=5e3,this.MAX_QUEUE_SIZE=100,this.config=Object.assign({apiBaseUrl:"https://api.lynk.coach/v1"},e),this.logger=new t("LynkAPI",e.debug),this.startFlushInterval()}startFlushInterval(){this.flushInterval||(this.flushInterval=window.setInterval(()=>{this.flush()},this.FLUSH_INTERVAL_MS))}stopFlushInterval(){this.flushInterval&&(clearInterval(this.flushInterval),this.flushInterval=null)}track(e){return n(this,void 0,void 0,function*(){this.queue.length>=this.MAX_QUEUE_SIZE&&(this.logger.warn("Queue full, flushing immediately"),yield this.flush());const t=Object.assign(Object.assign({},e),{timestamp:e.timestamp||Date.now(),academyId:this.config.academyId,sessionId:this.getSessionId(),url:window.location.href,referrer:document.referrer,userAgent:navigator.userAgent});this.queue.push(t),this.logger.debug("Event queued",t.eventName)})}flush(){return n(this,void 0,void 0,function*(){if(0===this.queue.length)return;const e=[...this.queue];this.queue=[];try{const t=yield fetch(`${this.config.apiBaseUrl}/events`,{method:"POST",headers:{"Content-Type":"application/json","X-Lynk-API-Key":this.config.apiKey},body:JSON.stringify({events:e}),keepalive:!0});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);this.logger.debug(`Flushed ${e.length} events`)}catch(t){this.logger.error("Failed to flush events",t),this.queue=[...e.slice(0,50),...this.queue].slice(0,this.MAX_QUEUE_SIZE)}})}getAcademyConfig(){return n(this,void 0,void 0,function*(){const e=yield fetch(`${this.config.apiBaseUrl}/academies/${this.config.academyId}/embed-config`,{headers:{"X-Lynk-API-Key":this.config.apiKey}});if(!e.ok)throw new Error(`Failed to fetch academy config: ${e.status}`);return e.json()})}getBatches(){return n(this,void 0,void 0,function*(){const e=yield fetch(`${this.config.apiBaseUrl}/academies/${this.config.academyId}/batches?available=true`,{headers:{"X-Lynk-API-Key":this.config.apiKey}});if(!e.ok)throw new Error(`Failed to fetch batches: ${e.status}`);return e.json()})}getAppointmentSlots(e){return n(this,void 0,void 0,function*(){const t=new URL(`${this.config.apiBaseUrl}/academies/${this.config.academyId}/appointments`);e&&t.searchParams.set("date",e);const i=yield fetch(t.toString(),{headers:{"X-Lynk-API-Key":this.config.apiKey}});if(!i.ok)throw new Error(`Failed to fetch appointment slots: ${i.status}`);return i.json()})}createBooking(e){return n(this,void 0,void 0,function*(){const t=yield fetch(`${this.config.apiBaseUrl}/bookings`,{method:"POST",headers:{"Content-Type":"application/json","X-Lynk-API-Key":this.config.apiKey},body:JSON.stringify(Object.assign(Object.assign({},e),{academyId:this.config.academyId}))});if(!t.ok)throw new Error(`Failed to create booking: ${t.status}`);return t.json()})}getSessionId(){var e;const t=`lynk_session_${this.config.academyId}`;let i=null===(e=document.cookie.match(new RegExp("(^| )"+t+"=([^;]+)")))||void 0===e?void 0:e[2];if(!i){i=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`;const e=new Date(Date.now()+18e5).toUTCString();document.cookie=`${t}=${i}; expires=${e}; path=/; SameSite=Lax`}return i}destroy(){this.stopFlushInterval(),this.flush()}}class a{constructor(e){this.initialized=!1,this.eventQueue=[],this.config=Object.assign({apiBaseUrl:"https://api.lynk.coach/v1",autoPageView:!0},e),this.logger=new t("LynkPixel",e.debug),this.api=new o(e)}init(){this.initialized?this.logger.warn("Pixel already initialized"):/bot|crawler|spider|crawling/i.test(navigator.userAgent)?this.logger.info("Bot detected, skipping pixel initialization"):(this.logger.info("Initializing Lynk Pixel",{academyId:this.config.academyId,pixels:Object.keys(this.config.pixels).filter(e=>this.config.pixels[e])}),this.loadGooglePixel(),this.loadFacebookPixel(),this.loadGoogleAnalytics(),this.captureAttribution(),this.config.autoPageView&&(this.trackPageView(),this.setupHistoryTracking()),this.initialized=!0,this.flushEventQueue(),window.lynkPixel=this,this.logger.info("Pixel initialized successfully"))}track(e,t){const i={name:e,data:t,timestamp:Date.now()};this.initialized?this.processEvent(i):this.eventQueue.push(i)}trackPageView(e){const t={path:(null==e?void 0:e.path)||window.location.pathname,title:(null==e?void 0:e.title)||document.title,url:window.location.href,referrer:document.referrer};this.track("page_view",t)}trackPurchase(e){this.track("purchase",e)}trackBeginCheckout(e){this.track("begin_checkout",e)}trackLead(e){this.track("generate_lead",e)}trackContact(e){this.track("contact",e)}processEvent(e){var t,i,n;this.logger.debug("Processing event",e),this.api.track({eventName:`pixel_${e.name}`,properties:e.data}),this.config.pixels.google&&!1!==(null===(t=this.config.consent)||void 0===t?void 0:t.marketing)&&this.sendToGoogle(e),this.config.pixels.facebook&&!1!==(null===(i=this.config.consent)||void 0===i?void 0:i.marketing)&&this.sendToFacebook(e),this.config.pixels.googleAnalytics&&!1!==(null===(n=this.config.consent)||void 0===n?void 0:n.analytics)&&this.sendToGA4(e)}loadGooglePixel(){if(!this.config.pixels.google)return;const e=document.createElement("script");e.async=!0,e.src=`https://www.googletagmanager.com/gtag/js?id=${this.config.pixels.google}`,document.head.appendChild(e),window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},window.gtag("js",new Date),window.gtag("config",this.config.pixels.google),this.logger.debug("Google Ads pixel loaded",{id:this.config.pixels.google})}loadGoogleAnalytics(){if(this.config.pixels.googleAnalytics){if(!window.gtag){const e=document.createElement("script");e.async=!0,e.src=`https://www.googletagmanager.com/gtag/js?id=${this.config.pixels.googleAnalytics}`,document.head.appendChild(e),window.dataLayer=window.dataLayer||[],window.gtag=function(){window.dataLayer.push(arguments)},window.gtag("js",new Date)}window.gtag("config",this.config.pixels.googleAnalytics),this.logger.debug("GA4 loaded",{id:this.config.pixels.googleAnalytics})}}loadFacebookPixel(){if(!this.config.pixels.facebook)return;const e=this.config.pixels.facebook,t=`\n      !function(f,b,e,v,n,t,s)\n      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?\n      n.callMethod.apply(n,arguments):n.queue.push(arguments)};\n      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';\n      n.queue=[];t=b.createElement(e);t.async=!0;\n      t.src=v;s=b.getElementsByTagName(e)[0];\n      s.parentNode.insertBefore(t,s)}(window, document,'script',\n      'https://connect.facebook.net/en_US/fbevents.js');\n      fbq('init', '${e}');\n      fbq('track', 'PageView');\n    `,i=document.createElement("script");i.textContent=t,document.head.appendChild(i),this.logger.debug("Facebook pixel loaded",{id:e})}sendToGoogle(e){var t,i,n,o;const a=window.gtag;if(!a)return;const s={purchase:"purchase",begin_checkout:"begin_checkout",generate_lead:"generate_lead",contact:"contact",page_view:"page_view"}[e.name]||"custom";a("event",s,Object.assign({send_to:this.config.pixels.google,value:null===(t=e.data)||void 0===t?void 0:t.value,currency:(null===(i=e.data)||void 0===i?void 0:i.currency)||"USD",transaction_id:null===(n=e.data)||void 0===n?void 0:n.transactionId,items:null===(o=e.data)||void 0===o?void 0:o.items},e.data)),this.logger.debug("Sent to Google",{event:s})}sendToGA4(e){const t=window.gtag;if(!t)return;t("event",{page_view:"page_view",purchase:"purchase",begin_checkout:"begin_checkout",generate_lead:"generate_lead",contact:"contact"}[e.name]||`custom_${e.name}`,Object.assign(Object.assign({},e.data),{academy_id:this.config.academyId}))}sendToFacebook(e){var t;const i=window.fbq;if(!i)return;const n={page_view:"PageView",purchase:"Purchase",begin_checkout:"InitiateCheckout",generate_lead:"Lead",contact:"Contact"}[e.name]||"CustomEvent",o=Object.assign({content_type:"product"},e.data);(null===(t=e.data)||void 0===t?void 0:t.value)&&(o.value=e.data.value,o.currency=e.data.currency||"USD"),i("track",n,o),this.logger.debug("Sent to Facebook",{event:n})}captureAttribution(){const e=function(){const e={},t=window.location.search;return t?(new URLSearchParams(t).forEach((t,i)=>{e[i]=t}),e):e}(),t=(new Date).toISOString();if(e.utm_source||e.utm_medium||e.utm_campaign){const n={source:e.utm_source||"direct",medium:e.utm_medium||"none",campaign:e.utm_campaign,content:e.utm_content,term:e.utm_term,timestamp:t};i("lynk_attribution",JSON.stringify(n),30),this.api.track({eventName:"attribution_captured",properties:n})}e.gclid&&i("lynk_gclid",e.gclid,30),e.fbclid&&i("lynk_fbclid",e.fbclid,30)}setupHistoryTracking(){const e=history.pushState,t=history.replaceState,i=this;history.pushState=function(...t){e.apply(this,t),i.trackPageView()},history.replaceState=function(...e){t.apply(this,e),i.trackPageView()},window.addEventListener("popstate",()=>{this.trackPageView()})}flushEventQueue(){for(;this.eventQueue.length>0;){const e=this.eventQueue.shift();e&&this.processEvent(e)}}setConsent(e){this.config.consent=Object.assign(Object.assign({},this.config.consent),e),this.logger.info("Consent updated",this.config.consent)}destroy(){this.api.destroy(),this.initialized=!1}}function s(){document.querySelectorAll("script[data-academy-id]").forEach(e=>{const t=e.getAttribute("data-academy-id"),i=e.getAttribute("data-api-key"),n=e.getAttribute("data-google-pixel"),o=e.getAttribute("data-facebook-pixel"),s=e.getAttribute("data-ga4-id"),c="true"===e.getAttribute("data-debug");if(!t||!i)return void console.error("Lynk Pixel: academy-id and api-key are required");new a({academyId:t,apiKey:i,debug:c,pixels:{google:n||void 0,facebook:o||void 0,googleAnalytics:s||void 0}}).init()})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),e.LynkPixel=a,e.default=a,Object.defineProperty(e,"__esModule",{value:!0})});
